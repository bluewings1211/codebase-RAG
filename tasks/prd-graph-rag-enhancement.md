# Product Requirements Document: Graph RAG 增強功能

## 1. Introduction/Overview

Graph RAG 增強功能旨在提升現有 codebase-rag-mcp 專案的搜尋精準度和智慧分析能力。透過結合 breadcrumb 層次關係、parent_name 結構資訊和 Qdrant 向量資料庫的進階查詢特性，建構一個代碼知識圖譜系統，支援跨專案協作、知識學習和技術轉移。

此功能將讓開發者和 AI 助手能夠更精確地理解代碼結構關係，從已索引的外部專案中學習最佳實踐，並獲得基於實際專案經驗的架構建議。

## 2. Goals

1. **提升搜尋精準度**：結合結構關係和語義相似性，提供更準確的代碼搜尋結果
2. **支援跨專案學習**：讓開發者能從其他已索引專案的實作中學習最佳實踐
3. **增強架構理解**：透過 breadcrumb 和 parent_name 分析，深度理解專案架構和設計模式
4. **提升開發效率**：減少開發者研究和學習新技術實作的時間成本
5. **強化 AI 助手能力**：為 MCP 工具提供更豐富的分析和建議基礎

## 3. User Stories

### 開發者場景
- **US-1**: 作為開發者，我想要找到其他專案如何實作 JWT 驗證，以便學習最佳實踐和避免常見陷阱
- **US-2**: 作為開發者，我想針對特定專案的使用者註冊流程做深度理解，以便在進行中的專案中實作類似功能
- **US-3**: 作為架構師，我想要比較不同專案的錯誤處理模式，以便選擇最適合當前專案的方案

### AI 助手場景
- **US-4**: 作為 AI 助手，我需要基於已索引的資料了解其他專案的實作架構和細節，以便提供使用者更精準的分析建議
- **US-5**: 作為 AI 助手，我想要追蹤特定功能的完整實作鏈（從 API 到資料層），以便理解端到端的架構設計

## 4. Functional Requirements

### 4.1 核心結構分析 (優先必要)
- **FR-4.1.1**: 系統必須能夠解析和提取代碼的 breadcrumb 層次關係 (如: services.auth.AuthService.validateToken)
- **FR-4.1.2**: 系統必須能夠識別和記錄 parent_name 關係 (類別、模組、命名空間)
- **FR-4.1.3**: 系統必須能夠建構代碼的結構關係圖，支援層次遍歷和相關組件查找

### 4.2 跨專案代碼搜尋 (優先必要)
- **FR-4.2.1**: 系統必須支援基於結構關係的跨專案搜尋 (如：找到所有 AuthService 類別的實作)
- **FR-4.2.2**: 系統必須結合語義搜尋和結構過濾，提供更精準的搜尋結果
- **FR-4.2.3**: 系統必須支援按專案、語言、複雜度等維度過濾搜尋結果
- **FR-4.2.4**: 系統必須能夠追蹤完整的實作鏈條 (從入口點到實作細節)

### 4.3 架構模式識別 (優先必要)
- **FR-4.3.1**: 系統必須能夠識別常見的架構模式 (MVC、分層架構、微服務等)
- **FR-4.3.2**: 系統必須能夠比較不同專案中相同功能的實作方式
- **FR-4.3.3**: 系統必須提供架構模式的結構化描述和比較分析

### 4.4 MCP 工具整合
- **FR-4.4.1**: 系統必須提供 `graph_analyze_structure` MCP 工具，支援分析特定 breadcrumb 的結構關係
- **FR-4.4.2**: 系統必須提供 `graph_find_similar_implementations` MCP 工具，支援跨專案相似實作搜尋
- **FR-4.4.3**: 系統必須提供 `graph_identify_patterns` MCP 工具，支援架構模式識別
- **FR-4.4.4**: 系統必須保持與現有 search 工具的兼容性和一致性

### 4.5 實作建議生成 (次要)
- **FR-4.5.1**: 系統應該能夠基於跨專案學習結果生成實作建議
- **FR-4.5.2**: 系統應該能夠提供基於複雜度和技術棧的個人化推薦

### 4.6 學習路徑推薦 (次要)
- **FR-4.6.1**: 系統應該能夠基於用戶查詢生成學習路徑和相關資源推薦
- **FR-4.6.2**: 系統應該能夠識別從簡單到複雜的實作進階路徑

## 5. Non-Goals (Out of Scope)

- **即時代碼索引**：僅支援已索引的專案，不支援即時索引外部專案
- **私有代碼權限控制**：第一版假設所有已索引專案都可互相參考，暫不實作細粒度權限控制
- **敏感資訊過濾**：假設代碼庫中的敏感資訊為假資料，暫不實作自動敏感資訊檢測
- **代碼自動生成**：僅提供分析和建議，不自動生成或修改代碼
- **實時協作功能**：不包含即時共享或協作編輯功能
- **非已支援語言**：僅支援目前 tree-sitter 已實作的程式語言

## 6. Technical Considerations

### 6.1 架構整合
- **與現有 Qdrant 服務整合**：擴展現有的 QdrantService 以支援複雜的關係查詢
- **擴展 CodeChunk 模型**：確保 breadcrumb 和 parent_name 欄位的正確提取和儲存
- **向後兼容性**：確保新功能不影響現有搜尋和索引功能

### 6.2 效能考量
- **查詢最佳化**：利用 Qdrant 的 query_filter 和 scroll_filter 最佳化複雜查詢效能
- **快取策略**：對常用的結構關係查詢實作快取機制
- **批次處理**：支援大量代碼塊的批次關係分析

### 6.3 資料一致性
- **專案標記統一**：確保跨專案查詢時的專案識別一致性
- **關係圖更新**：當代碼更新時，確保結構關係圖的同步更新

## 7. Design Considerations

### 7.1 MCP 工具介面設計
- **一致性**：新的 Graph RAG 工具應與現有 MCP 工具保持介面風格一致
- **易用性**：工具參數應該直觀易懂，支援合理的預設值
- **擴展性**：介面設計應考慮未來功能擴展的需求

### 7.2 結果呈現格式
- **結構化輸出**：搜尋結果應包含清晰的結構關係資訊和來源追蹤
- **可視化支援**：考慮提供結構關係圖的文字描述格式

## 8. Success Metrics

### 8.1 技術指標
- **搜尋精準度**：相關實作搜尋的 precision@5 達到 85% 以上
- **響應時間**：Graph RAG 查詢平均響應時間不超過 3 秒
- **覆蓋率**：能夠正確識別 90% 以上的 breadcrumb 層次關係

### 8.2 使用者體驗指標
- **開發效率提升**：使用者報告在學習新技術實作時效率提升 30% 以上
- **採用率**：新 MCP 工具的月活躍使用率達到 60% 以上
- **滿意度**：使用者對跨專案學習功能的滿意度達到 4.0/5.0 以上

## 9. Open Questions

1. **breadcrumb 提取策略**：對於不同程式語言，breadcrumb 的命名規則和深度如何統一？
2. **架構模式定義**：需要預先定義哪些架構模式的識別規則？
3. **相似度閾值**：跨專案搜尋時，語義相似度和結構相似度的權重如何平衡？
4. **效能最佳化**：對於大型專案群，如何確保複雜關係查詢的效能？
5. **錯誤處理**：當 breadcrumb 或 parent_name 提取失敗時，如何優雅降級？
6. **未來擴展**：如何為未來的使用者權限系統預留擴展空間？

---

**文件版本**: v1.0
**建立日期**: 2025-01-17
**負責人**: AI Assistant
**審核狀態**: 待審核
