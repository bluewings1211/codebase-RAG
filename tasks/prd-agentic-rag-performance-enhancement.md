# PRD: Agentic-RAG 性能增強專案

## 1. Introduction/Overview

本專案旨在解決 Agentic-RAG 系統在處理大型代碼庫時的性能瓶頸問題。當前系統在圖構建和檢索時存在響應時間過長、資源消耗過大的問題，特別是 MCP 工具在處理複雜查詢時經常超過可接受的響應時間。

通過融合 LightRAG 和 PathRAG 的先進技術，本專案將實現輕量化圖服務、路徑基礎索引、流式剪枝和多模態檢索機制，以顯著提升系統性能和用戶體驗。

**核心目標**：將圖生成和圖搜索相關 MCP 工具的響應時間控制在 15 秒內，同時保持甚至提升代碼理解的準確性。

## 2. Goals

### 主要目標
1. **響應時間改善**：圖生成和圖搜索 MCP 工具響應時間在 15 秒內完成
2. **性能提升**：整體查詢響應速度提升 40%
3. **大型項目支援**：移除現有的 `max_chunks_for_mcp = 5` 限制，支援完整項目分析
4. **資源效率**：減少 50% 的內存佔用峰值

### 次要目標
1. **準確性保持**：在性能提升的同時，保持或提升代碼理解準確率 10-15%
2. **用戶體驗**：提供更靈活的檢索模式選擇
3. **系統穩定性**：改善系統在高負載下的穩定性

## 3. User Stories

### 主要用戶故事

**US-001**: 作為使用 MCP 工具的開發者，我希望能夠快速分析大型代碼庫的結構關係，讓我可以在 15 秒內獲得項目的架構圖和組件關係，而不必等待數分鐘。

**US-002**: 作為使用圖搜索功能的用戶，我希望能夠快速找到函數間的調用路徑，讓我可以在短時間內理解代碼的執行流程，提升debugging效率。

**US-003**: 作為分析複雜項目的研究人員，我希望系統能夠處理包含數千個文件的大型項目，讓我可以進行全面的代碼架構分析，而不受到人為的chunk數量限制。

**US-004**: 作為需要不同層次分析的用戶，我希望能夠選擇不同的檢索模式（局部/全局/混合），讓我可以根據查詢需求獲得最適合的結果。

### 輔助用戶故事

**US-005**: 作為系統管理員，我希望系統在處理大型查詢時不會消耗過多資源，讓服務器能夠同時處理多個用戶請求。

**US-006**: 作為 Agent 開發者，我希望 MCP 工具有合理的預設配置，讓 Agent 能夠自動選擇最佳的檢索策略，無需複雜的參數調整。

## 4. Functional Requirements

### 4.1 輕量化圖服務 (Priority: High)

**FR-001**: 系統必須提供無需構建完整圖的查詢機制，支援按需部分圖構建。

**FR-002**: 系統必須實現內存索引機制，將關鍵節點元數據保存在內存中以快速查詢。

**FR-003**: 系統必須支援預計算常用查詢結果，包括入口點、主要函數、公共API等。

**FR-004**: 系統必須提供智能路徑查找功能，優先使用緩存和索引進行快速路徑查找。

**FR-005**: 系統必須移除 `max_chunks_for_mcp = 5` 的限制，支援處理完整項目。

### 4.2 路徑基礎索引和流式剪枝 (Priority: High)

**FR-006**: 系統必須實現關係路徑提取，包括執行路徑、數據流路徑和依賴路徑。

**FR-007**: 系統必須提供流式剪枝機制，自動移除冗餘和低價值的檢索結果。

**FR-008**: 系統必須支援路徑聚類和代表性路徑選擇，提升檢索效率。

**FR-009**: 系統必須實現路徑到提示的轉換機制，為LLM提供結構化的上下文。

### 4.3 多模態檢索機制 (Priority: High)

**FR-010**: 系統必須支援四種檢索模式：local（局部）、global（全局）、hybrid（混合）、mix（自適應）。

**FR-011**: 系統必須提供自動檢索模式選擇，基於查詢複雜度和意圖智能選擇最佳策略。

**FR-012**: 系統必須支援高低層次關鍵詞分離提取，提升檢索精準度。

**FR-013**: 系統必須提供檢索模式手動選擇選項，允許用戶和Agent指定特定模式。

### 4.4 性能和響應時間 (Priority: Critical)

**FR-014**: 圖生成相關的MCP工具必須在15秒內完成響應。

**FR-015**: 圖搜索相關的MCP工具必須在15秒內完成響應。

**FR-016**: 系統必須提供查詢超時機制，超時時返回部分結果而非完全失敗。

**FR-017**: 系統必須實現漸進式結果返回，優先返回高置信度的結果。

### 4.5 MCP工具接口 (Priority: Medium)

**FR-018**: 系統必須保持現有MCP工具接口不變，確保向前兼容性。

**FR-019**: 系統必須為新功能提供合理的預設參數，支援自動配置。

**FR-020**: 系統必須在工具參數中暴露檢索模式選項，同時提供預設值。

**FR-021**: 圖搜索和建圖相關功能可以進行破壞性變更以優化性能。

### 4.6 監控和診斷 (Priority: Medium)

**FR-022**: 系統必須提供性能監控儀表板，追蹤響應時間、內存使用等關鍵指標。

**FR-023**: 系統必須記錄查詢模式和性能統計，支援後續優化。

**FR-024**: 系統必須提供診斷工具，幫助識別性能瓶頸和優化機會。

## 5. Non-Goals (Out of Scope)

### 5.1 功能範圍限制
- **不包含新的程式語言支援**：專注於現有8+語言的性能優化
- **不包含UI/UX介面改變**：僅優化後端性能，不改變用戶介面
- **不包含全新的MCP工具**：僅優化現有工具的性能

### 5.2 性能範圍限制
- **不保證所有查詢15秒內完成**：僅限圖生成和圖搜索相關工具
- **不支援無限制的項目大小**：仍需合理的資源使用限制
- **不提供實時協作功能**：專注於單用戶查詢性能

### 5.3 兼容性限制
- **不保證舊版本API完全兼容**：圖搜索和建圖功能可進行破壞性變更
- **不支援舊版本數據格式**：可能需要重新索引現有項目

## 6. Design Considerations

### 6.1 架構設計
- **分層架構**：保持現有的服務層架構，在其上添加優化層
- **插件化設計**：新功能以插件形式實現，便於獨立測試和部署
- **緩存策略**：多層緩存設計（L1: 內存索引, L2: 路徑緩存, L3: 查詢結果緩存）

### 6.2 用戶介面設計
- **預設優先**：所有新功能都有合理的預設值，無需用戶配置
- **漸進增強**：高級用戶可以通過參數進行細粒度控制
- **狀態反饋**：提供查詢進度和預估完成時間的反饋

### 6.3 數據結構設計
- **輕量化節點**：圖節點僅包含必要元數據，詳細內容按需加載
- **索引優化**：使用高效的索引結構（如倒排索引、布隆過濾器）
- **壓縮存儲**：對緩存數據進行壓縮以減少內存使用

## 7. Technical Considerations

### 7.1 系統依賴
- **Qdrant服務**：需要升級查詢策略以支援更高效的向量檢索
- **Redis緩存**：需要擴展緩存策略以支援新的多層緩存需求
- **Tree-sitter解析器**：保持現有解析能力，優化解析性能

### 7.2 性能約束
- **內存限制**：新功能的內存使用不應超過現有系統的150%
- **CPU使用**：查詢期間CPU使用率峰值不應超過80%
- **並發處理**：支援至少5個並發查詢而不影響響應時間

### 7.3 數據遷移
- **索引重建**：現有項目可能需要重新索引以支援新功能
- **增量更新**：提供增量索引更新機制以減少重建時間
- **回退機制**：提供回退到舊版本索引的機制

### 7.4 錯誤處理
- **優雅降級**：當新功能失敗時，自動回退到原有功能
- **部分結果**：超時情況下返回已計算的部分結果
- **錯誤記錄**：詳細記錄性能相關錯誤以便後續優化

## 8. Success Metrics

### 8.1 核心性能指標

**主要成功指標**：
- **響應時間達標率**：圖生成和圖搜索工具95%以上的查詢在15秒內完成
- **整體響應速度提升**：平均查詢響應時間減少40%
- **內存使用優化**：內存使用峰值減少50%
- **大型項目處理能力**：能夠處理超過1000個文件的項目而不受chunk限制

**次要成功指標**：
- **準確性保持**：代碼理解準確率提升10-15%或至少保持現有水準
- **系統穩定性**：99%以上的查詢成功完成（不包括用戶錯誤）
- **併發處理能力**：支援5個並發用戶同時查詢而不影響響應時間

### 8.2 用戶體驗指標

- **工具可用性**：95%以上的MCP工具調用成功返回結果
- **用戶滿意度**：基於現有測試資料夾的基準測試，性能改善明顯可感知
- **錯誤率降低**：因性能問題導致的工具失敗減少80%

### 8.3 技術指標

- **緩存命中率**：路徑緩存命中率達到70%以上
- **索引效率**：內存索引查詢時間少於100ms
- **資源利用率**：CPU和內存使用更加平衡，避免資源浪費

## 9. Implementation Timeline

### Phase 1: 輕量化圖服務 (Weeks 1-6)
- **Week 1-2**: 實現內存索引和預計算查詢機制
- **Week 3-4**: 開發按需部分圖構建功能
- **Week 5-6**: 移除chunk限制並進行性能測試

### Phase 2: 路徑基礎索引 (Weeks 7-12)
- **Week 7-8**: 實現關係路徑提取算法
- **Week 9-10**: 開發流式剪枝機制
- **Week 11-12**: 建立路徑到提示的轉換系統

### Phase 3: 多模態檢索 (Weeks 13-16)
- **Week 13-14**: 實現四種檢索模式
- **Week 15-16**: 開發智能模式選擇和查詢分析

### Phase 4: 整合和優化 (Weeks 17-19)
- **Week 17**: 系統整合和端到端測試
- **Week 18**: 性能調優和基準測試
- **Week 19**: 部署準備和文檔更新

## 10. Testing Strategy

### 10.1 基準測試
- **現有測試數據**：使用 `src/tests/` 資料夾中的測試案例作為性能基準
- **回歸測試**：確保所有現有功能在優化後仍正常工作
- **壓力測試**：使用大型開源項目（如React、Vue等）進行壓力測試

### 10.2 性能驗證
- **響應時間測試**：自動化測試確保95%查詢在15秒內完成
- **內存使用監控**：持續監控內存使用情況，確保不超過目標限制
- **並發測試**：模擬多用戶並發查詢場景

### 10.3 功能驗證
- **準確性測試**：確保優化後的結果與原始結果一致或更優
- **邊界條件測試**：測試極大項目、複雜查詢等邊界情況
- **錯誤恢復測試**：驗證錯誤處理和優雅降級機制

## 11. Risk Assessment

### 11.1 技術風險 (High)
- **風險**：複雜的性能優化可能引入新的錯誤
- **緩解**：分階段實施，每階段都有完整的測試和回退計劃
- **監控**：實時性能監控和錯誤追蹤

### 11.2 性能風險 (Medium)
- **風險**：可能無法達到15秒響應時間目標
- **緩解**：採用漸進式優化，每個階段都測量實際改善
- **應變**：如無法達到目標，提供部分結果和進度反饋

### 11.3 兼容性風險 (Low)
- **風險**：破壞性變更可能影響現有用戶
- **緩解**：僅對圖搜索和建圖功能進行破壞性變更，其他功能保持兼容
- **應變**：提供遷移工具和詳細的升級指南

## 12. Open Questions

1. **資源限制**：對於超大型項目（>10,000文件），是否需要設定新的合理限制？

2. **緩存策略**：不同項目類型是否需要不同的緩存策略？

3. **多語言優先級**：是否需要針對特定程式語言優先優化？

4. **監控粒度**：性能監控需要多細緻的粒度？是否需要查詢級別的監控？

5. **用戶反饋**：如何收集用戶對性能改善的反饋以指導後續優化？

6. **擴展計劃**：未來是否計劃支援分散式部署以處理更大規模的查詢？

## 13. References

### 技術參考資料

**LightRAG 相關**：
- **LightRAG GitHub 專案**：https://github.com/HKUDS/LightRAG
  - 提供四種檢索模式（local/global/hybrid/mix）的實現參考
  - 輕量化設計和智能 token 管理機制
  - 雙層檢索架構的核心實現

**PathRAG 相關**：
- **PathRAG 研究論文**：https://arxiv.org/abs/2502.14902
  - 流式剪枝技術和路徑基礎提示的理論基礎
  - 索引圖組織方法和性能提升指標
  - 結構化依賴關係捕獲的創新方法

- **PathRAG 實現專案**：https://github.com/embedded-robotics/path-rag
  - 智能片段提取策略的實踐應用
  - 多階段推理流程的具體實現
  - 域特定知識檢索的方法論

**技術分析參考**：
- **YouTube 技術分析**：ai_docs/extra_info.json
  - 業界專家對 LightRAG 和 PathRAG 的深度解析
  - 實際應用效果和性能改善案例
  - 醫療等敏感領域的應用考量和限制

### 內部參考文件

- **詳細技術分析**：tasks/lightrag-pathrag-analysis-and-improvement-recommendations.md
  - 完整的 LightRAG 和 PathRAG 技術分析
  - 現有系統優缺點的深度剖析
  - 具體改善建議和實施方案

---

**文檔版本**：1.0  
**創建日期**：2025-07-24  
**最後更新**：2025-07-24  
**審核狀態**：待審核